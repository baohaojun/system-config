#!/bin/bash

exec 2> ~/tmp/get-firefox-tab-url.log
set -x

export SAWFISH_BROWSER_INPUT_SLEEP=${SAWFISH_BROWSER_INPUT_SLEEP:-.05}
current_clipboard=$(getclip)
. atexit putclip "${current_clipboard}"
. atexit bhj-notify get-firefox-tab-url "finished"

empty_clipboard=@empty@

putclip "${empty_clipboard}"

for x in $(seq 1 5); do
    xdotool key F22
    sleep .1
    out=$(
        getclip |grep . ||
        xclip -o
    )

    if test "$out" = "${empty_clipboard}"; then
        echo out not ready >> ~/.cache/system-config/logs/$(basename $0).log
        for y in $(seq 1 5); do
            sleep .03
            out=$(
                getclip |grep . ||
                xclip -o
            )
            if test "$out" != "${empty_clipboard}"; then
                echo out became "'$out'" at $x/$y >> ~/.cache/system-config/logs/$(basename $0).log
                echo -n ${out%/}
                exit 0
            fi
        done
    else
        echo -n ${out%/}
        exit 0
    fi
done
