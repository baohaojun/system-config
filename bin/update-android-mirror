#!/bin/bash
set -ex

. ~/system-config/.bashrc
. ~/system-config/bin/set-ssh-agent


(
    cd ~/src/android-mirror/ || exit 0
    if ! is-tty-io; then
        (
            cd ~/src/android-mirror/kernel/msm.git || exit 0
            git fetch https://github.com/mirrors/linux
        )

        (
            repo init -u s:qualcomm/platform/manifest.git -b sanfrancisco -m sfo-rom.xml
            repo sync -j8 -f -m icesky-rom.xml
            repo sync -j8 -f -m sfo-rom.xml
            cd ~/src/android-mirror/kernel/linux.git
            git fetch linus
        ) || true
    fi

    export http_proxy=http://localhost:8888
    export https_proxy=http://localhost:8888
    for branch in $(
                       (        cd .repo/manifests >/dev/null 2>&1
                                git branch -a | grep -P -e '/android-\d' | sort -n | tail -n 1 | perl -npe 's,.*/,,'
                       )

                       if test ! -e .repo/update-android-branches; then
                           echo master > .repo/update-android-branches
                       fi
                       cat .repo/update-android-branches 2>/dev/null || true
                   );
    do
        if repo-switch -u https://android.googlesource.com/platform/manifest -b $branch -m default.xml; then
            repo sync -j1 || true
        fi
    done
)

#git clone --mirror --bare git://android.git.kernel.org/tools/repo.git
cd ~/src/android-mirror/git-repo.git
git fetch
echo ok, repo update complete
