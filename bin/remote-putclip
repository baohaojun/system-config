#!/bin/bash

set -xe
unset REMOTEIP
EMACS=t
. ~/system-config/bin/set-ssh-agent

set -e

me=$(readlink -f $BASH_SOURCE)
if test ! -e "$me"; then
    me=$(readlink -f "$(which $BASH_SOURCE)")
    if test ! -e "$me"; then
        die "Can't find out about me"
        exit 1
    fi
fi

abs0=$BASH_SOURCE
if ! [[ $abs0 =~ ^/ ]]; then
    if [[ $abs0 =~ / ]] && test -e $PWD/$abs0; then
        abs0=$PWD/$abs0
    elif test -e "$(which $BASH_SOURCE)"; then
        abs0=$(which $BASH_SOURCE)
    else
        die "Can't find abs path for $BASH_SOURCE"
    fi
fi

b0=$(basename $BASH_SOURCE)

if test "${b0}" = remote-putclip; then
    if [[ $1 =~ ^/jssh: ]]; then
        remote_file=$1
        if [[ $remote_file =~ '"' ]]; then
            die "Can't work with a remote file that has \" in it!"
        fi
        emacsclient -e "$(
cat <<'EOFcc64d0fa4b94' | . .replace-%% --
; {%emacs-lisp-mode%}
(with-temp-buffer
  (insert-file-contents "<%remote-file%>")
  (kill-ring-save (point-min) (point-max)))
; {%/emacs-lisp-mode%}
EOFcc64d0fa4b94
)"

        exit 0
    fi

    if [[ $1 =~ ^(/scp|/ssh): ]]; then
        set -- "${1#/*:}"
    fi

    if [[ $1 =~ \#[0-9]+ ]]; then
        port=$(echo "$1" | perl -npe 's/.*#(\d+):.*/$1/')
        set -- -e "ssh -p $port" "$(echo "$1" | perl -npe 's/#(\d+):/:/')"
    fi

    rsync "$@" /tmp/remote-putclip.$$
    DISPLAY=:0
    . ~/.renew-xauth
    cat /tmp/remote-putclip.$$ | putclip
    rm /tmp/remote-putclip.$$
elif test "${b0}" = remote-putfile; then
    file=~/tmp/remote-putfile/"$1"

    mkdir -p $(dirname "$file")

    if ! [[ "$(readlink -m "${file}")" =~ ~/tmp/remote-putfile/ ]]; then
        die "Can't putfile $1, it's too dangerous to write files out of ~/tmp/remote-putfile/"
    fi

    cat > "${file}"
fi
