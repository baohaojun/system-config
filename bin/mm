#!/bin/bash
function die() {
    echo Error: "$@"
    exit -1
}

PATH_PREPEND=
TEMP=$(getopt -o p: -n $(basename $0) -- "$@")

eval set -- "$TEMP"
while true; do
    case "$1" in
        -p)
            if test "$PATH_PREPEND"; then
                PATH_PREPEND="$PATH_PREPEND:$2"
            else
                PATH_PREPEND=$2
            fi
            shift 2
            ;;
        --)
            shift
            break
            ;;
        *)
            die "internal error"
            ;;
    esac
done

time (
    set -e
    set -o pipefail
    build_env=$(lookup-file build/envsetup.sh)
    top_dir=$(dirname $build_env)
    top_dir=$(readlink -f $top_dir/..)

    oldpwd=$PWD
    cd $top_dir/
    . build/envsetup.sh
    set_stuff_for_environment
    OUT_DIR=${OUT%target/*}
    cd $oldpwd

    cd "$(dirname $(lookup-file Android.mk))"
    ONE_SHOT_MAKEFILE=$(readlink -f $PWD/Android.mk)
    export ONE_SHOT_MAKEFILE=${ONE_SHOT_MAKEFILE:1+${#top_dir}}

    cd $top_dir

    perl -npe 's!^\$\(error stopping\)!#\$(error stopping)!' -i build/core/main.mk

    (
        echo '# -*- mode: compilation -*-'
        echo "make: Entering directory \`$(lookup-file .repo/..)'"
        . $OUT_DIR/.buildenv.sh
        if test ${PATH_PREPEND}x != x; then
            PATH=$PATH_PREPEND:$PATH
        fi
        ONE_SHOT_MAKEFILE=$ONE_SHOT_MAKEFILE make all_modules showcommands "$@" 2>&1
    ) | tee ~/.logs/mm.log.$$

    echo OK
    cd $top_dir/
    rm -f out
    relative-link $(dirname $(readlink -f $OUT_DIR/host)) out
)
