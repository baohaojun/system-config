#!/bin/bash
set -e

## start code-generator "^\\s *#\\s *"
# generate-getopt r:remote h:GERRIT-HOST aauto ccheckout
## end code-generator
## start generated code
TEMP=$(getopt -o ah:r:ch \
              --long auto,GERRIT-HOST:,remote:,checkout,help,no-auto,no-checkout \
              -n $(basename -- $0) -- "$@")
auto=false
GERRIT_HOST=
remote=
checkout=false
eval set -- "$TEMP"
while true; do
    case "$1" in

        -a|--auto|--no-auto)
            if test "$1" = --no-auto; then
                auto=false
            else
                auto=true
            fi
            shift
            ;;
        -h|--GERRIT-HOST)
            GERRIT_HOST=$2
            shift 2
            ;;
        -r|--remote)
            remote=$2
            shift 2
            ;;
        -c|--checkout|--no-checkout)
            if test "$1" = --no-checkout; then
                checkout=false
            else
                checkout=true
            fi
            shift
            ;;
        -h|--help)
            set +x
            echo
            echo
            echo Options and arguments:
            printf %06s '-a, '
            printf %-24s '--[no-]auto'
            echo
            printf %06s '-c, '
            printf %-24s '--[no-]checkout'
            echo
            printf %06s '-h, '
            printf %-24s '--GERRIT-HOST=GERRIT_HOST'
            echo
            printf %06s '-r, '
            printf %-24s '--remote=REMOTE'
            echo
            exit
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            die "internal error"
            ;;
    esac
done

## end generated code

if test -e ~/src/github/smartcm/scm-helpers/.gerrit-fetch-review.hooks; then
    . ~/src/github/smartcm/scm-helpers/.gerrit-fetch-review.hooks
fi

export GERRIT_HOST

export REPO_REMOTE=$remote

tmpf=/tmp/$(basename $0).$$
if test $# = 1 -a "${1:0:4}" = http; then
    if echo "$1" |grep -q "/\d+/\d+$" -P; then
        set -- $(echo "$1"|perl -npe 's,.*/(\d+)/\d+$,$1,')
    else
        set -- "$(basename "$1")"
    fi
fi


gerrit query "$@" --current-patch-set > $tmpf

function die() {
    echo "$@"
    exit -1
}


export PROJECT=$(cat $tmpf|grep 'project: '|pn 2)

git_dir=$(my-rfa 'if [[ $PROJECT =~ $(repo-project)$ ]]; then pwd; fi')

if test -n "$git_dir"; then
    cd $(lookup-file .repo/..) || die repo not found.
    cd $git_dir || die "$git_dir: cd failed"
fi
ref=$(cat $tmpf|grep 'ref: '|pn 2|tail -n 1)
git fetch $(repo-remote-url $remote) $ref
if test "$checkout" = true; then
    git checkout FETCH_HEAD
fi

if test "$auto" = true; then
    start_recursive_shell gerrit
fi
