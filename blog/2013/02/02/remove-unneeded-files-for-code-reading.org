#+title: åœ¨é˜…è¯»æºä»£ç æ—¶åˆ æ‰æ‰€æœ‰éå¿…è¦æ–‡ä»¶çš„æ–¹æ³•
# bhj-tags: code-reading

åœ¨é˜…è¯»kernelã€ubootç­‰é¡¹ç›®çš„æºä»£ç çš„æ—¶å€™ï¼Œä¼šå‘ç°æœ‰å¾ˆå¤§çš„å™ªéŸ³æ¥è‡ªäºä¸€äº›ä¸
ç›¸å¹²çš„CPUçš„ä»£ç ã€‚æ¯”å¦‚æˆ‘å¸çš„pxa1088ï¼Œå…¶ubootçœŸæ­£buildæ—¶ç”¨åˆ°çš„æ–‡ä»¶åªæœ‰ä¸
åˆ°400ä¸ªï¼Œä½†æ•´ä¸ªubooté‡Œå…±æœ‰å¤šå°‘æ–‡ä»¶å‘¢ï¼Ÿ6000å¤šä¸ªï¼

æ€ä¹ˆæƒ³ä¸ªåŠæ³•æŠŠæ‰€æœ‰ä¸ç›¸å¹²çš„æ–‡ä»¶éƒ½å»æ‰å‘¢ï¼Ÿ

æˆ‘æœ‰ä¸ªä¸»æ„ï¼š

1. æŠŠæ‰€æœ‰æºä»£ç æ–‡ä»¶éƒ½touchä¸€ä¸‹ï¼š

   #+BEGIN_EXAMPLE
   git ls-tree HEAD -r |pn 4|xargs touch
   #+END_EXAMPLE

2. å¼„å‡ºä¸€ä¸ªæ ‡è®°æ–‡ä»¶ï¼Œ =touch mark=

3. åšä¸ªfull build

4. æŠŠæ‰€æœ‰æ¯” =mark= æ–°çš„æ–‡ä»¶éƒ½é€‰å‡ºæ¥ï¼Œè¿™é‡Œçš„æ–°ä¸æ˜¯æ”¹åŠ¨ï¼Œè€Œæ˜¯è®¿é—®ï¼Œä¹Ÿå°±æ˜¯
   åœ¨ =mark= è¢«åˆ›å»ºä¹‹åè¢«ç¬¬3æ­¥çš„full buildè®¿é—®åˆ°è¿‡çš„æ–‡ä»¶ã€‚æ‰€ä»¥ç”¨
   =find= å‘½ä»¤çš„è¯å¯ä»¥è¿™æ ·åšï¼š =find . -anewer mark= 

5. åé€‰è®¿é—®æ—¶é—´æ¯” =mark= æ—§çš„æ–‡ä»¶ï¼Œè¿™äº›æ˜¯full buildæ—¶æ²¡æœ‰ç”¨åˆ°çš„æ–‡ä»¶ï¼Œå¯
   ä»¥å®‰å…¨åœ°æŠŠå®ƒä»¬åˆ é™¤ã€‚

6. åˆ å®Œä¹‹åå†åšä¸€éfull buildï¼ŒéªŒè¯ä¸€ä¸‹æ²¡æœ‰åˆ æ‰ä¸è¯¥åˆ çš„æ–‡ä»¶å¯¼è‡´buildå¤±
   è´¥ã€‚

ä½†æ˜¯å¾ˆå¯æƒœï¼Œè¿™ä¸ªä¸»æ„æ²¡æ³•åœ¨ubooté‡Œç”¨ã€‚åœ¨ç¬¬4æ­¥çš„æ—¶å€™ï¼Œä½ ä¼šå‘ç°æ‰€æœ‰æºä»£ç 
æ–‡ä»¶éƒ½è¢«è®¿é—®è¿‡äº†ã€‚è¿™æ˜¯æ€ä¹ˆå›äº‹å„¿å‘¢ï¼Ÿ

ç”¨straceå¯ä»¥å‘Šè¯‰æˆ‘ä»¬ç­”æ¡ˆã€‚ä¸€è¾¹åœ¨åšfull buildçš„æ—¶å€™ç”¨straceæŸ¥çœ‹æ‰€æœ‰ç³»ç»Ÿ
è°ƒç”¨ï¼ŒåŠ ä¸Š =-f= å‚æ•°è¡¨ç¤ºè·Ÿè¸ªæ‰€æœ‰forkå‡ºæ¥çš„å­è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨: 

#+BEGIN_EXAMPLE
(cd $(lookup-file-dir .repo);
 . build/envsetup.sh;
 cd boot; 
 BUILD_UBOOT_OBM=true; 
 set -x;
 . ../.buildenv.sh;
 cd uboot;
 strace -f time make -j8 helan_ff_config;
 strace -f time make -j8) 2>&1 | tee ~/1.txt
#+END_EXAMPLE


å¦ä¸€è¾¹ç”¨ =watch= å‘½ä»¤ç›‘æµ‹æŸä¸ªä¸ç›¸å¹²çš„æ–‡ä»¶ä»€ä¹ˆæ—¶å€™å…¶ =atime= å‘ç”Ÿäº†å˜åŒ–ï¼š

#+BEGIN_EXAMPLE
watch -n 1 stat drivers/mmc/arm_pl180_mmci.c
#+END_EXAMPLE

å½“å‘ç°å…¶atimeå‘ç”Ÿå˜åŒ–ä¹‹åå†å»çœ‹ =~/1.txt= é‡Œæ˜¯å“ªä¸ªè¿›ç¨‹åœ¨æé¬¼ï¼Œç„¶åä»æ–‡
ä»¶å¤´å¼€å§‹æŸ¥è¿™ä¸ªè¿›ç¨‹æ˜¯æ€æ ·è¢«execçš„ã€‚

#+BEGIN_EXAMPLE
$ grep drivers/mmc/arm_pl180_mmci.c ~/1.txt
[pid   684] lstat("drivers/mmc/arm_pl180_mmci.c", {st_mode=S_IFREG|0644, st_size=11286, ...}) = 0
[pid   684] open("drivers/mmc/arm_pl180_mmci.c", O_RDONLY) = 6
[pid   694] lstat("drivers/mmc/arm_pl180_mmci.c", {st_mode=S_IFREG|0644, st_size=11286, ...}) = 0

$ grep ' 684]' ~/1.txt|head -n 5
[pid   684] close(10)                   = 0
[pid   684] execve("/usr/bin/git", ["git", "update-index", "--refresh", "--unmerged"], [/* 78 vars */]) = 0
[pid   684] brk(0)                      = 0x25b6000
[pid   684] access("/etc/ld.so.nohwcap", F_OK) = -1 ENOENT (No such file or directory)
[pid   684] mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2b5c68ec2000
#+END_EXAMPLE

æœ€åå‘ç°æ˜¯ä¸€ä¸ª =git update-index ...= çš„å‘½ä»¤è°ƒç”¨ã€‚ç›´æ¥åœ¨ubootç›®å½•ä¸‹
=rgrep update-index= å‘ç°æ˜¯ä¸€ä¸ªsetlocalversionè„šæœ¬ï¼Œå®ƒä¼šäº§ç”Ÿç±»ä¼¼
=-02978-ge39e5db= è¿™æ ·çš„è¾“å‡ºã€‚

æŠŠè¿™ä¸ªè„šæœ¬ä¿®æ­£ä¹‹åï¼Œå°±å¯ä»¥è¾¾åˆ°æˆ‘çš„ç›®çš„äº†ï¼Œä½ ä½“ä¼šä¸€ä¸‹ğŸ˜Š

*åè®°* æ–‡ä»¶çš„atimeæœ‰æ—¶å€™ä¸çŸ¥ä¸ºä½•ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚æˆ‘æ›¾ç»çœ‹è§ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸ç®¡
æˆ‘æ€ä¹ˆcatå®ƒï¼Œå®ƒçš„atimeä¸€ç›´ä¸å˜ã€‚è€Œå®ƒæ‰€åœ¨çš„æ–‡ä»¶ç³»ç»Ÿå¹¶æ²¡æœ‰ä½¿ç”¨noatimeé€‰é¡¹
æ¥mountã€‚ä¿®æ­£çš„åŠæ³•å°±æ˜¯æŠŠå®ƒtouchä¸€ä¸‹ï¼Œstatå¯ä»¥å‘ç°å…¶a/m/cä¸‰ä¸ªæ—¶é—´æˆ³éƒ½æ˜¯
ä¸€æ ·çš„ï¼Œå†catä¸€ä¸‹ï¼Œå†statå°±ä¼šå‘ç°å…¶atimeå‘ç”Ÿäº†å˜åŒ–ã€‚æ‰€ä»¥å‰é¢æŒ‡å‡ºçš„ç¬¬ä¸€
æ­¥æ˜¯å¿…é¡»çš„ã€‚æœ‰äººèƒ½å‘Šè¯‰æˆ‘è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢å—ï¼Ÿ

*åè®°2* æŠŠæ‰€æœ‰atimeæ²¡å‘ç”Ÿå˜åŒ–ï¼ˆæ²¡å˜å¾—æ¯”æ ‡è®°æ–‡ä»¶markæ–°ï¼‰çš„æ–‡ä»¶åˆ—å‡ºæ¥çš„å‘½
ä»¤æˆ‘ç°åœ¨æƒ³åˆ°æœ€ç®€æ´çš„æ˜¯è¿™æ ·çš„ï¼š

#+BEGIN_EXAMPLE
find . -type f \( -anewer mark -prune -o -print \)
#+END_EXAMPLE

å½“ç„¶ï¼Œå¦‚æœä½ æƒ³æŠŠè¿™äº›æ–‡ä»¶åˆ æ‰çš„è¯éœ€è¦æ³¨æ„æŠŠ.gitåº•ä¸‹çš„æ–‡ä»¶ç»™è¿‡æ»¤å‡ºå»ï¼š =|grep -v \\.git= ã€‚


*åè®°3* kernelä»£ç ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•åˆ é™¤ébuildå¿…é¡»çš„æ–‡ä»¶ã€‚ä½†å®ƒçš„
setlocalversionè„šæœ¬æ˜¯åœ¨scriptsä¸‹ï¼ˆubooté‡Œæœ‰å¾ˆå¤šä¸œè¥¿æ˜¯ç›´æ¥ä»kernelé‡Œâ€œå·â€æ¥
çš„ï¼‰ã€‚ä»åŸç†ä¸Šè¯´åº”è¯¥å…¶ä»–è½¯ä»¶ä¹Ÿéƒ½èƒ½ç”¨è¿™ä¸ªæ–¹æ³•åˆ æ‰é‚£äº›â€œnoise for code
readingâ€çš„æ–‡ä»¶ï¼Œä½†æ•ˆæœæ ¹æ®é¡¹ç›®ä¸åŒè€Œå¼‚å§ï¼Œä¸å¯èƒ½æœ‰kernel/ubooté‚£ä¹ˆå¤¸å¼ 
äº†ã€‚

*åè®°4* é’ˆå¯¹ubootå’Œkernelæˆ‘åˆ†åˆ«å†™äº†ä¸¤ä¸ªè„šæœ¬ï¼Œä¸€æ­¥å®Œæˆè¿™é‡Œé¢çš„æ‰€æœ‰æ“ä½œï¼Œ
ä½†ä¸€å¦‚æ—¢å¾€åœ°ï¼Œä½ æƒ³è¦ç”¨è¿™ä¸¤ä¸ªè„šæœ¬çš„è¯ï¼Œéœ€è¦è‡ªå·±æ”¹æ”¹ã€‚

åˆ†åˆ«åœ¨ [[http://github.com/baohaojun/system-config/raw/master/bin/rm-non-build-files-uboot][for uboot]] å’Œ [[http://github.com/baohaojun/system-config/raw/master/bin/rm-non-build-files-kernel][for kernel]] ã€‚
