#+title: Cannot connect to adb under linux because of option module
# bhj-tags: Bug

æ€ä¹ˆè§£å†³linuxä¸‹æ‰¾ä¸åˆ°adbçš„é—®é¢˜
  :PROPERTIES:
  :ID:       c43359c6-b493-487e-beca-4e6c1e740f6e
  :END:

å“¥ä»¬åœ¨Linuxåº•ä¸‹å·¥ä½œï¼Œä»æ¥æ²¡æœ‰å‘ç”Ÿè¿‡adbè®¾å¤‡æ‰¾ä¸åˆ°çš„é—®é¢˜ï¼Œæ‰‹æœºä¸€æ’ä¸ŠLinuxæœºå™¨ï¼Œå¦‚æœæ‰¾ä¸åˆ°adbï¼Œå‡ ä¹å¯ä»¥è‚¯å®šè¿™ä¸ªæ‰‹æœºæ˜¯åçš„ï¼Œæˆ–è€…usbçº¿æ˜¯åçš„ã€‚

ä¸åƒåœ¨Windowsä¸‹ï¼Œç”¨adbè¿ä¸ªæ‰‹æœºæœ‰å¾ˆå¤šæ§½ç‚¹ã€‚æ¯”å¦‚è¦è£…é©±åŠ¨ï¼Œæ¯”å¦‚ä½œä¸ºå°å‚å•†ï¼Œæˆ‘ä»¬åªèƒ½è‡ªå·±æ”¹æ”¹è°·æ­Œç»™çš„å®˜æ–¹é©±åŠ¨â€”â€”è¿™ä¸ªæ˜¯æ²¡è¿‡å¾®è½¯é©±åŠ¨è®¤è¯çš„ï¼Œåœ¨Windows7ä¸Šä»¥çš„Windowsç‰ˆæœ¬å‡ ä¹è£…ä¸ä¸Šâ€”â€”åæ­£æˆ‘æ˜¯ä¸çŸ¥é“æ€ä¹ˆè£…ã€‚

ä½†æœ€è¿‘çªç„¶å¾ˆèƒŒçš„å‘ç°ï¼Œæˆ‘çš„Linuxæœºå™¨ä¸è®¤æˆ‘çš„æ‰‹æœºadbäº†ï¼Œäºæ˜¯è´¹äº†å¾ˆå¤§çš„åŠ²æŸ¥è¿™ä¸ªäº‹æƒ…ï¼Œåˆšåˆšç»ˆäºâ€œå®Œç¾â€è§£å†³äº†ï¼ˆåŠ å¼•å·æ˜¯å› ä¸ºå¥½åƒæ˜¯å®Œç¾è§£å†³äº†ğŸ˜…ï¼‰ã€‚

é¦–å…ˆæ‰¯ç‚¹è·Ÿè¿™ä¸ªé—®é¢˜æ— å…³çš„ï¼Œå…³äºLinuxä¸‹ç”¨adbä¸€èˆ¬éƒ½ä¼šç¢°åˆ°çš„é—®é¢˜ã€‚é‚£å°±æ˜¯adb usbä¸€æ’ä¸Šæ¥ï¼Œé»˜è®¤è¿™ä¸ªè®¾å¤‡æ˜¯rootç”¨æˆ·çš„ï¼Œæˆ‘ä»¬ä½œä¸ºæ™®é€šç”¨æˆ·ç™»å½•ï¼Œæ˜¯æ— æ³•æ“ä½œè¿™ä¸ªè®¾å¤‡çš„ï¼Œé™¤éä½ çš„ç³»ç»Ÿé‡Œè®¾ç½®è¿‡äº†ç›¸å…³çš„è§„åˆ™ï¼Œè¿™ä¸ªè®¾å¤‡æ’ä¸Šæ¥çš„æ—¶å€™ï¼Œç³»ç»Ÿå…è®¸ä½ æ“ä½œå®ƒä½ æ‰èƒ½çœ‹åˆ°adb devicesã€‚

å–å†³äºä½ å¯¹è®¾å¤‡æœ‰æ²¡æœ‰è¯»æƒé™å’Œå†™æƒé™ï¼Œå¦‚æœæ²¡æœ‰è¯»æƒé™ï¼Œé‚£ä½ çš„adb devicesé‡Œæ ¹æœ¬çœ‹ä¸åˆ°è¿™ä¸ªè®¾å¤‡ç›¸å…³çš„ä¿¡æ¯ï¼›å¦‚æœæœ‰è¯»æƒé™ï¼Œä½†æ˜¯æ²¡æœ‰å†™æƒé™ï¼Œé‚£ä¹ˆä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¾“å‡ºï¼š

#+BEGIN_EXAMPLE
d064b0b3        no permissions
#+END_EXAMPLE

å¦‚æœå‘ç°è¿™ç§æƒ…å†µï¼Œè§£å†³çš„åŠæ³•æ˜¯é€šè¿‡udevè§„åˆ™ï¼Œè®©è®¾å¤‡ä¸€æ’ä¸Šæ¥å°±æ”¹ä¸€ä¸‹æƒé™/æ‰€æœ‰è€…ï¼Œè®©ä½ å¯ä»¥æ“ä½œå®ƒã€‚æˆ‘å°è£…äº†ä¸€ä¸ªfix-usb-permissionçš„å‘½ä»¤ï¼Œç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œä½ ä¸å¦¨ä¸€è¯•ã€‚

å¦å¤–æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯åœ¨é”¤å­ç§‘æŠ€çš„æ—©æœŸï¼Œå› ä¸ºæˆ‘ä»¬çš„usbè®¾å¤‡å‚å•†idæ²¡æœ‰åŠ å…¥åˆ°è°·æ­Œçš„ä»£ç åº“ï¼Œå¯¼è‡´å¿…é¡»åœ¨ =~/.android/adb_usb.ini= é‡Œå†™ä¸€ä¸ª =0x29a9= ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„usbå‚å•†idã€‚

å›åˆ°è¿™å›ç¢°åˆ°çš„é—®é¢˜ï¼Œä¸çŸ¥ä»ä»€ä¹ˆæ—¶å€™èµ·ï¼Œå¯èƒ½å› ä¸ºæˆ‘ç»å¸¸å‡çº§æˆ‘çš„debianç³»ç»Ÿï¼Œçªç„¶æœ‰ä¸€å¤©å°±å‘ç°adbè®¤ä¸å‡ºæ‰‹æœºæ¥äº†ï¼Œå¶å°”èƒ½è®¤å‡ºæ¥ï¼Œä½†å¤§å¤šæ•°æ—¶å€™éƒ½è®¤ä¸å‡ºæ¥ã€‚

ç¢°åˆ°è¿™ç§æƒ…å†µï¼ŒæŸ¥é—®é¢˜æ—¶æœ‰å‡ ä¸ªå›ºå®šçš„â€œä¸‰æ¿æ–§â€ï¼Œå¦‚ä¸‹ï¼š

1. çœ‹lsusbè¾“å‡ºï¼Œèƒ½çœ‹åˆ°æˆ‘çš„Smartisan T2æ‰‹æœºï¼š

   #+BEGIN_EXAMPLE
   Bus 001 Device 027: ID 29a9:701a
   #+END_EXAMPLE

2. ç”¨dmesgçœ‹kernelçš„logï¼š

   #+BEGIN_EXAMPLE
   [188316.830836] option 1-2:1.0: GSM modem (1-port) converter detected
   [188316.831869] usb 1-2: GSM modem (1-port) converter now attached to ttyUSB0
   #+END_EXAMPLE

ä¸€ä¸‹å°±å‘ç°é—®é¢˜äº†ï¼ŒåŸæ¥æŠŠæˆ‘çš„æ‰‹æœºè®¤æˆä¸€ä¸ªmodemäº†ã€‚

è§£å†³é—®é¢˜çš„æ—¶å€™ï¼Œè¯•äº†å¥½å‡ ä¸ªæ–¹æ¡ˆã€‚æ³¨æ„åˆ°ä¸Šé¢kernel logé‡Œç¬¬ä¸€è¡Œæåˆ°äº† â€œoptionâ€ï¼Œè¿™æ˜¯ä¸€ä¸ªkernel usbçš„.koæ¨¡å—ï¼Œäºæ˜¯åœ¨googleä¸Šæœï¼Œå¥½åƒæœ‰äººè¯´å¯ä»¥é€šè¿‡ =/etc/modprobe.d/= ä¸‹çš„blacklistæœºåˆ¶æŠŠå®ƒç»™ç¦ç”¨æ‰ã€‚æˆ‘è¯•äº†ä¸€ä¸‹ï¼ŒæŠŠoptionç¦ç”¨æ‰ä¹‹åï¼Œæˆ‘çš„usbé”®ç›˜å’Œé¼ æ ‡éƒ½ä¸èƒ½ç”¨äº†ã€‚

äºæ˜¯è¯•äº†ä¸€ä¸‹å¦ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨udevè§„åˆ™é‡Œç›´æ¥ =rmmod option= ï¼Œå‘ç°æƒ…å†µæœ‰å¥½è½¬ï¼Œadbè®¤å‡ºæ¥çš„æ¦‚ç‡é«˜äº†å¾ˆå¤šï¼Œä½†è¿˜æ˜¯ç»å¸¸ä¸æˆåŠŸï¼Œè€æ˜¯æç¤º option æ¨¡å—è¢«å ç”¨ï¼Œä¸èƒ½å¸è½½ã€‚

åæ¥ä¸å°å¿ƒè¯•äº†ä¸€ä¸‹ =lsusb -t= å‘½ä»¤ï¼ŒåŠ ä¸Š =-t= å‚æ•°æ‰“å°æ›´å¤šä¿¡æ¯ï¼Œç»“æœå‘ç°å½“adbèƒ½ç”¨çš„æ—¶å€™ï¼Œ =lsusb -t= çš„è¾“å‡ºé‡Œæ˜¾ç¤ºæ˜¯è¿™æ ·çš„ï¼š

#+BEGIN_EXAMPLE
    |__ Port 2: Dev 28, If 0, Class=Vendor Specific Class, Driver=, 480M
#+END_EXAMPLE

å½“adbä¸èƒ½ç”¨è¢«è®¤æˆGSM modemçš„æ—¶å€™ï¼Œè¾“å‡ºæ˜¯è¿™æ ·çš„ï¼š

#+BEGIN_EXAMPLE
    |__ Port 2: Dev 27, If 0, Class=Vendor Specific Class, Driver=option, 480M
#+END_EXAMPLE

äºæ˜¯å¼€å§‹çŒ›æœåœ¨linuxä¸‹æ€ä¹ˆå¼ºåˆ¶æ”¹å˜usbçš„driverï¼Œæœ€åæ²¡æ‰¾åˆ°è¿™ä¸ªï¼Œä½†å€’çš„ç¡®æ‰¾åˆ°ä¸€ä¸ªæ€ä¹ˆå¼ºåˆ¶â€œunbindâ€ä¸€ä¸ªusbè®¾å¤‡çš„é©±åŠ¨çš„æ–¹æ³•ï¼ˆgoogle â€œusb driver unbindâ€ï¼Œç¬¬ä¸€æ¡å°±æ˜¯ï¼‰ã€‚

ç„¶åå†™äº†å¦‚ä¸‹çš„udevè§„åˆ™ï¼š

#+BEGIN_EXAMPLE
SUBSYSTEM=="usb", ATTR{idVendor}=="29a9", RUN+="/home/bhj/system-config/bin/rmmod-option" OWNER="bhj"
#+END_EXAMPLE

æœ€åï¼Œ =rmmod-option= è¿™ä¸ªè„šæœ¬æ˜¯è¿™æ ·çš„ï¼š

#+BEGIN_SRC sh
  #!/bin/bash

  me=$(readlink -f $0)
  if test ! -e "$me"; then
      me=$(readlink -f "$(which $0)")
      if test ! -e "$me"; then
          die "Can't find out about me"
          exit 1
      fi
  fi

  if test "$RUNNING_WITH_MY_OWN_SESSION" != true; then
      echo "export RUNNING_WITH_MY_OWN_SESSION=true; $me" | at now
  fi

  (
      echo '****************************************************************'
      set
      echo
  ) >> /tmp/$(basename $0).$UID

  if ! is-tty-io; then
      exec > /tmp/$(basename $0).txt 2>&1
  fi
  set -x

  cd /sys/bus/usb/drivers/option
  # DEVPATH=/devices/pci0000:00/0000:00:14.0/usb1/1-2
  devpath=$(basename $DEVPATH)

  (
      for n in $(seq 1 20); do
          done_unbind=false
          for x in *ğŸ˜—; do
              if test ! -e "$x"; then
                  break
              fi
              if test "${x%ğŸ˜—}" = "$devpath" -o "$(cat $x/interface)" = "ADB Interface"; then
                  echo "$x" | tee unbind || true
                  done_unbind=true
              fi
          done
          echo time: $n
          sleep .2 || true
      done

      bhj_cmd=$(cat <<EOF
          exec > /tmp/rmmod-option.\$UID 2>&1
          set -x
          if my-adb devices?; then
              if my-adb devices? | grep "offline\$"; then
                  ps-killall adb.fork-server
              fi
          fi
          if test "$ID_SERIAL_SHORT" = "\$(get-about-me adb-serial)"; then
              ask-to-sync-org
          fi
  EOF
  )
      su - bhj -c "echo \"$bhj_cmd\"|at now"
  )&

#+END_SRC

ä½ çœ‹çš„æ—¶å€™ï¼Œä¼°è®¡ä¼šè§‰å¾—éå¸¸å¥‡æ€ªï¼Œé‡Œé¢ä¸ºä»€ä¹ˆä¸ç›´æ¥å¹²æ´»ï¼Œè€Œè¦ç”¨åˆ°at nowæŠŠæ´»æ‰”åˆ°é‚£ä¸ªé‡Œé¢å»å¹²å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºudevå¯åŠ¨çš„è¿›ç¨‹ä¼šè¢«ç³»ç»Ÿç›‘æ§ï¼Œå¦‚æœä¸èƒ½åœ¨å‡ ç§’é’Ÿå†…å¿«é€Ÿç»“æŸçš„è¯ï¼Œç³»ç»Ÿå°±ä¼šå¼ºè¡Œå°†å…¶åœæ­¢ã€‚æ‰€ä»¥ï¼Œåœ¨ç½‘ä¸ŠæŸ¥äº†ä¸€ç•ªä¹‹åï¼Œå‘ç°äº†è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼ŒæŠŠæ´»æ‰”åˆ°at daemoné‡Œå»ã€‚åé¢è¿˜ç”¨åˆ°ä¸€æ¬¡atï¼Œé‚£ä¸ªåˆ™æ˜¯å› ä¸ºæˆ‘å¦‚æœå‘ç°è‡ªå·±çš„daily useæ‰‹æœºæ’ä¸Šæ¥çš„è¯ï¼Œä¼šè·Ÿå®ƒåŒæ­¥ä¸€ä¸‹æˆ‘çš„org-modeæ—¥ç¨‹ï¼Œä½†è¿‡ç¨‹ä¸­è¦ç”¨åˆ°sawfishçš„ä¸€äº›ç•Œé¢æç¤ºï¼Œç„¶è€Œå¦‚æœåœ¨at daemoné‡Œï¼Œrootèº«ä»½å¯¼è‡´å³ä½¿å·²ç»suæˆbhjï¼Œä¹Ÿä¸å¯ä»¥è¿æ¥æˆ‘ä¸ªäººbhjç”¨æˆ·çš„sawfishï¼Œå› ä¸ºæ¯æ¬¡ä¸€è¿å°±ä¼šå»è¿rootè‡ªå·±çš„sawfishï¼Œè€Œé‚£ä¸ªæ˜¯ä¸å­˜åœ¨çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåˆåœ¨su bhjä¹‹åä¸ç›´æ¥å¹²æ´»ï¼Œè€Œæ˜¯å†æ¬¡æ‰”ç»™at daemonï¼Œä½†è¿™æ¬¡çš„at daemonå¹²æ´»çš„æ—¶å€™å·²ç»ä¸æ˜¯rootï¼Œè€Œæ˜¯bhjäº†ã€‚

æœ€åï¼Œè¿™ä¸ªæ–¹æ³•è¿˜æ˜¯ä¸å¾ˆä¿é™©ï¼Œå¶å°”è¿˜ä¼šå‘ç”Ÿè®¤ä¸å‡ºadb devicesæˆ–adb devicesæ˜¾ç¤ºofflineçš„æƒ…å†µã€‚å¦‚æœæœ‰å¯¹æ­¤ç†Ÿæ‚‰çš„æœ‹å‹ï¼Œè¿˜è¯·ä¸åèµæ•™ã€‚
