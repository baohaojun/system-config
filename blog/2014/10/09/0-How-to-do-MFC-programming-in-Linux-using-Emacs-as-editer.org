#+title: å¦‚ä½•åœ¨Linux + Emacsä¸‹è¿›è¡ŒMFCç¼–ç¨‹ï¼ˆä»£ç è¡¥é½ï¼‰

# bhj-tags: tool
æœ€æ—©åœ¨ [[http://www.newsmth.net/bbstcon.php?board=Emacs&gid=107420][æ°´æœ¨çš„è¿™ä¸ªè´´å­]] é‡Œè¯´äº†è¿™ä»¶äº‹ã€‚å›å¤´æƒ³æƒ³ï¼Œè‡ªå·±æ˜¯ä¸æ˜¯çœŸçš„æ›´é€‚åˆå»æè¡Œä¸ºè‰ºæœ¯å‘¢ï¼Ÿå¤´è„‘æ­£å¸¸ä¸€ç‚¹çš„ç¨‹åºå‘˜åº”è¯¥ä¸ä¼šè¿™ä¹ˆå¹²çš„ğŸ˜„ã€‚

æ—¢ç„¶åšäº†ï¼Œå°±è¯´è¯´æ€ä¹ˆåšçš„å§ï¼Œè¯´ä¸å®šæœ‰åæ¥äººä¹Ÿæƒ³è¿™ä¹ˆå¹²...

é¦–å…ˆï¼Œå…ˆè®²ç‚¹èƒŒæ™¯ã€‚è¿™ä¸ªè¡¥é½è¦ç”¨åˆ°clangï¼Œä¹Ÿå°±æ˜¯è‹¹æœå…¬å¸åœ¨å¬é›†å¼€å‘çš„ä¸€ä¸ª
æ¯”gccæ›´æ–°çš„ä¸€ä¸ªå¼€æºç¼–è¯‘å™¨ï¼Œä¸llvmç›¸ç»“åˆï¼Œæ®è¯´å¾ˆå¤§çš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯ä»£ç ç»„ç»‡
å¾—æ¯”gccæ›´å¥½ä¸€äº›...

å®ƒæœ‰ä¸€ä¸ªè‡ªå¸¦çš„è¡¥é½åŠŸèƒ½ï¼ˆ =-code-completion-at= çš„å‘½ä»¤è¡Œé€‰é¡¹ï¼‰ï¼è¿™ä¸ªè¡¥
é½åŠŸèƒ½ä¸éœ€è¦æ•´ä¸ªCæºæ–‡ä»¶èƒ½æ­£ç¡®ç¼–è¯‘æ‰å¯ä»¥æ­£ç¡®è¡¥é½ï¼Œå› ä¸ºå¦åˆ™çš„è¯å°±æˆäº†é¸¡
è‚‹äº†ã€‚æ‰€ä»¥ç”¨å®ƒæ¥åšLinux+Emacsä¸‹çš„MFCç¼–ç¨‹è¡¥é½æ˜¯å®Œå…¨å¯è¡Œçš„ï¼Œæˆ‘åªéœ€è¦æŠŠ
MFCç›¸å…³çš„ä¸€äº›å¤´æ–‡ä»¶ç»™å¼„åˆ°Linuxåº•ä¸‹æ¥ã€‚

ç„¶åå°±æ˜¯å¦‚æ°´æœ¨ä¸Šçš„é‚£ä¸ªè´´å­é‡Œæ‰€è¯´çš„ï¼Œä¸åœåœ°ä¿®æ­£äº†clangè¡¥é½æ—¶æŠ¥å‡ºæ¥çš„ä¸€
äº›é”™è¯¯ã€‚è¿™äº›é”™è¯¯éƒ½ä¼šæ”¾åœ¨ä¸€ä¸ªä¸´æ—¶çš„ï¼ˆ*xx*è¿™æ ·å‘½åçš„ï¼‰bufferé‡Œï¼Œä¸€æ¡ä¸€æ¡
çš„ä¿®æ­£å°±å¥½äº†ï¼Œæœ€åä¹Ÿæ²¡å¿…è¦å…¨éƒ¨ä¿®å®Œï¼Œå› ä¸ºæœ‰äº›ä¸œè¥¿å¯èƒ½æ˜¯å¾®è½¯è‡ªå·±çš„ç¼–è¯‘å™¨
ç‰¹æœ‰çš„å¯¹C++è¯­è¨€çš„æ‰©å……ï¼Œclangæ˜¯å¤„ç†ä¸äº†çš„ã€‚

æœ‰å‡ ä¸ªå¾ˆå®¹æ˜“ä¿®çš„é”™è¯¯ï¼Œå½¢æˆçš„åŸå› éƒ½æ˜¯ä¸€ä¸ªï¼šå¾®è½¯çš„æ–‡ä»¶åä¸åŒºåˆ†å¤§å°å†™ã€‚ç„¶
åå°±ç»å¸¸å¯ä»¥çœ‹åˆ° =StdAfx.h= å’Œ =stdafx.h= è¿™æ ·çš„å†™æ³•åˆ°å¤„éƒ½æ˜¯ï¼Œè²Œä¼¼æ˜¯éš
æœºçš„ğŸ˜‚ å¯¹è¿™ä¸ªé”™è¯¯çš„è¯å¹¸å¥½æˆ‘ä»¥å‰æœ‰ç§¯ç´¯ï¼Œå†™è¿‡ä¸€ä¸ª [[https://github.com/baohaojun/system-config/raw/master/bin/refactory-rename][rename-refactory]] çš„è„š
æœ¬ï¼Œå¾ˆå¿«å°±å…¨éƒ¨æ”¹å®Œäº†ã€‚

å“¦ï¼Œæˆ‘åˆšæ‰checkoutå‡ºæ¥æˆ‘çš„æ”¹åŠ¨çœ‹äº†ä¸€ä¸‹ï¼Œæˆ‘çš„ä¹ æƒ¯çœŸæ˜¯å¤ªå¥½äº†ï¼ŒæŠŠè‡ªå·±ä»¥å‰
æ€ä¹ˆåšçš„å…¨éƒ¨å†™æˆäº†ä¸€ä¸ªè„šæœ¬ï¼Œç„¶åç°åœ¨å†™æ–‡ç« çš„æ—¶å€™çœ‹ä¸€ä¸‹è„šæœ¬å°±å…¨æƒ³èµ·æ¥äº†ï¼š

#+BEGIN_SRC sh
#!/bin/bash
set -e
# ./fix-compile.h '(cd ~/src/tools/SmartisanTestFrame/branch_DailyDev/TestFrame; cat /home/bhj/src/tools/SmartisanTestFrame/branch_DailyDev/TestFrame/TestFrameDlg.cpp | /usr/bin/clang -cc1 -fsyntax-only -x c++ -I/home/bhj/.cache/vc/include -I/home/bhj/.cache/vc/atlmfc/include -I/home/bhj/.cache/vc/sdk/include -I/home/bhj/src/tools/SmartisanTestFrame/branch_DailyDev/Public/Smartisan/ -I/usr/include/x86_64-linux-gnu/qt5/QtConcurrent -I/usr/include/x86_64-linux-gnu/qt5/QtCore -I/usr/include/x86_64-linux-gnu/qt5/QtDBus -I/usr/include/x86_64-linux-gnu/qt5/QtGui -I/usr/include/x86_64-linux-gnu/qt5/QtNetwork -I/usr/include/x86_64-linux-gnu/qt5/QtOpenGL -I/usr/include/x86_64-linux-gnu/qt5/QtOpenGLExtensions -I/usr/include/x86_64-linux-gnu/qt5/QtPlatformSupport -I/usr/include/x86_64-linux-gnu/qt5/QtPrintSupport -I/usr/include/x86_64-linux-gnu/qt5/QtSql -I/usr/include/x86_64-linux-gnu/qt5/QtTest -I/usr/include/x86_64-linux-gnu/qt5/QtWidgets -I/usr/include/x86_64-linux-gnu/qt5/QtXml -I/usr/include/x86_64-linux-gnu/qt5 -I/usr/include/c++/4.9 -I/usr/include/x86_64-linux-gnu/c++/4.9 -I/usr/include/c++/4.9/backward -I/usr/lib/gcc/x86_64-linux-gnu/4.9/include -I/usr/local/include -I/usr/lib/gcc/x86_64-linux-gnu/4.9/include-fixed -I/usr/include/x86_64-linux-gnu -I/usr/include -I. -code-completion-at -:711:61 -)'

while true; do
    x=$(bash -c "$@" 2>&1 | tr -d '\r' | grep "fatal error:.*' file not found") || true
    if test "$x"; then
        x=$(echo "$x" | perl -npe "s/.*fatal error: '(.*)' file not found.*/\$1/")
        for y in $x; do ./fix-it.sh "$y"; done
    else
        break
    fi
done
#+END_SRC

æœ€å‰é¢ä½ ç”šè‡³å¯ä»¥çœ‹åˆ°æˆ‘è®°å½•äº†ä¸€ä¸‹è¿™ä¸ªè„šæœ¬æ˜¯æ€ä¹ˆç”¨çš„ï¼ˆå› ä¸º.bash_history
å¹¶ä¸èƒ½æ— é™åœ°è®°å½•ä½ ç”¨è¿‡çš„æ‰€æœ‰å‘½ä»¤ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªå¯ä»¥è‡ªå·±è®¾çš„ä¸Šé™ï¼Œä½†å¦‚æœä½ 
è®¾å¾—è¶…çº§å¤§çš„è¯ä¼šå¯¼è‡´ä½ çš„bashäº¤äº’å¯åŠ¨å˜æ…¢ğŸ˜Šï¼‰ã€‚è¿™æ˜¯æˆ‘çš„åˆä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œé˜²æ­¢
è‡ªå·±ä»¥åå¿˜äº†æ€ä¹ˆç”¨ï¼ŒåŒ…æ‹¬å†™åšå®¢æ–‡ç« æ—¶ï¼‰ã€‚è¿™ä¸ªè„šæœ¬åŸºæœ¬ä¸Šå°±æ˜¯æˆ‘ä¸åœåœ°åœ¨ç”¨
clangå»è¡¥é½ï¼Œç„¶åæŠŠ =file not found= çš„é”™è¯¯å…¨éƒ¨æªå‡ºæ¥ï¼Œç”¨ä¸€ä¸ª
=fix-it.sh= åšä¸€ä¸ªç®€å•ç²—æš´çš„ä¿®æ­£ã€‚

=fix-it.sh= è„šæœ¬æ˜¯è¿™æ ·çš„ï¼š

#+BEGIN_SRC sh
#!/bin/bash
for x in $(find . -iname $1); do
    ln -s "$(basename "$x")" "$(dirname "$x")"/$1 -v
    exit 0
done
exit -1
#+END_SRC

æˆ‘æ‰¾åˆ°ä¸€ä¸ªï¼ˆ =-iname= å‚æ•°ï¼Œä¸åŒºåˆ†å¤§å°å†™ï¼‰ =$1= æŒ‡å®šçš„æ–‡ä»¶ï¼Œå°±ç”¨ =ln=
æŠŠè¿™ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶ =$x= åšä¸€ä¸ªåˆ°ç›®æ ‡æ–‡ä»¶ =$1= çš„è½¯é“¾æ¥ã€‚ä½ ä½“ä¼šä¸€ä¸‹ğŸ˜„

æœ€åï¼ŒæŠŠè¿™ç±»æ–‡ä»¶åä¸åŒºåˆ†å¤§å°å†™é€ æˆçš„é”™è¯¯å…¨ä¿®æ­£å®Œä¹‹åï¼Œå°±æ˜¯ä¸€ä¸ª
=fix-it.h= æ–‡ä»¶ï¼Œé‡Œé¢çš„å†…å®¹æ˜¯è¿™æ ·ï¼ˆå†æ¬¡ï¼Œç®€å•ç²—æš´ï¼‰çš„ï¼š

#+BEGIN_SRC c
#define __int64 long long
#define __int32 int
#define __int16 short
#define __int8 char
#define __w64
#define __possibly_notnullterminated
#define SORTPP_PASS
#define _M_IX86
#define _WCHAR_T_DEFINED
#define _WIN32
#define __uuidof(a) (*(CLSID*)((a*)0))
#define _inline
#define __thiscall
#define _CRTNOALIAS
#define _CRTRESTRICT
#define DECLSPEC_IMPORT
#define _NTSYSTEM_
#define AFXAPI
#define _DLL
#define _CRTIMP2
#define _CRTIMP
#define _MRTIMP2
#define __stdcall
#define __interface class
#define __pragma(...)
#define __fastcall
#define __forceinline
class type_info;
#+END_SRC

æœ€åï¼Œå°±æ˜¯clangå’Œgccéƒ½æ”¯æŒçš„ä¸€ä¸ª =-include= å‚æ•°ï¼ŒæŠŠè¿™ä¸ª =fix-it.h= æ–‡
ä»¶æ¯æ¬¡éƒ½includeè¿›æ¥å†åšè¡¥é½ï¼Œå°±ä¸ä¼šæœ‰é‚£ä¹ˆå¤šé”™è¯¯äº†ã€‚è¿™äº›è®¾ç½®æœ€åä¼šå†™åˆ°
Emacs çš„ =.dir-locals.el= æ–‡ä»¶é‡Œï¼ŒçŸ¥é“çš„å°±ä¸ç”¨å¤šè¯´äº†ğŸ˜„ã€‚

ä»¥ä¸Šè¡Œä¸ºè‰ºæœ¯å®Œæˆäºæˆ‘åœ¨é”¤å­ç§‘æŠ€å·¥ä½œæ—¶ï¼Œæ„Ÿè°¢ã€‚
