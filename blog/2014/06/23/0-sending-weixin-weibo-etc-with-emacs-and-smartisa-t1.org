#+title: åœ¨Linuxä¸‹ç”¨Emacs+Smartisan T1æ‰‹æœºå‘weixin/weibo/qq/email/sms
# bhj-tags: tool
å¤§å®¶å¥½ï¼Œä»Šå¤©æˆ‘ä»¬æ¥è®²ä¸€è®²æ€ä¹ˆåœ¨Linuxä¸‹ï¼Œç”¨Emacs+Smartisan T1æ¥å‘å¾®ä¿¡ã€
å¾®åšã€QQç­‰æ“ä½œã€‚

å…¶å®è¿™åªæ˜¯ä¸€ä¸ªé«˜åº¦è‡ªåŠ¨åŒ–çš„è¿‡ç¨‹ï¼Œæˆ‘æŠŠå‡ ä¸ªå…³é”®ç‚¹å…ˆè¯´ä¸€è¯´ã€‚

1. ç”¨Emacsç¼–è¾‘è¦å‘é€çš„å†…å®¹
2. æŠŠå†…å®¹adb pushåˆ°æ‰‹æœºä¸Šï¼Œæ”¾å…¥æ‰‹æœºçš„å‰ªè´´æ¿
3. æ“ä½œæ‰‹æœºçš„è¾“å…¥ï¼Œä¸€èˆ¬æ˜¯é•¿æŒ‰ç¼–è¾‘æ¡†ï¼Œç‚¹ç²˜è´´ï¼Œå†ç‚¹å‘é€æŒ‰é’®

ä¸ºäº†å®Œæˆä»¥ä¸Šçš„æ­¥éª¤ï¼Œæˆ‘å†™äº†å¾ˆå¤šè„šæœ¬ï¼Œä¸‹é¢æ˜¯æ›´è¯¦ç»†çš„è¯´æ˜ã€‚

* ç”¨Emacsç¼–è¾‘å†…å®¹

è¿™é‡Œæˆ‘ä¼šç”¨åˆ°å‡ ä¸ªè„šæœ¬ï¼Œæ¯”å¦‚ä¸€ä¸ªå«weixinçš„è„šæœ¬ï¼Œè¿˜æœ‰ä¸€ä¸ªå«weiboçš„è„šæœ¬ã€‚
å®ƒä»¬åˆ†åˆ«æ˜¯ç”¨æ¥å‘å¾®ä¿¡å’Œå¾®åšç”¨çš„ã€‚ä½†å®é™…ä¸Šï¼Œè¿™ä¸¤ä¸ªè„šæœ¬æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚å—¯ï¼Œ
åœ¨è¿™é‡Œæˆ‘é‡‡å–äº†busyboxçš„åšæ³•ï¼Œæ ¹æ® =argv[0]= æ¥å†³å®šç¨‹åºä¸åŒçš„è¡Œä¸ºï¼ˆåœ¨
shellç¼–ç¨‹ä¸­ç›¸åº”çš„æ˜¯ =$(basename $0)= äº†ï¼‰ã€‚

è¿™ä¸ªè„šæœ¬çš„ä½ç½®åœ¨ [[https://github.com/baohaojun/system-config/raw/master/bin/adb-send-weixin][adb-send-weixin]]ï¼š
#+BEGIN_SRC sh
#!/bin/bash

export USE_BUFFER_NAME=send-to-$(basename $0).org
(
    if ! flock -n 9; then
        find-or-exec emacs "No such thing"
        emacsclient -e '(switch-to-buffer "'$USE_BUFFER_NAME'")'
        exit
    fi

    while true; do
        input=$(ask-for-input-with-emacs -p "What do you want say on $(basename $0)?" || true)
        if ! test "$input"; then
            exit
        fi
        (
            flock 10
            putclip-android "$input"&
            if test $(basename $0) = google+; then
                adb-long-press 144 374 # long press
                adb-tap 117 273 # paste
                adb-tap 949 935 # send
            elif test $(basename $0) = weibo; then
                adb input keyevent SPACE
                adb-long-press 440 281; adb-tap 545 191
                adb-tap 991 166
            elif test $(basename $0) = t1-sms; then
                adb-tap 560 1840 # ç‚¹ç©ºæ ¼
                adb-long-press 522 912 # é•¿æŒ‰è¾“å…¥æ¡†
                adb-tap 480 802
                adb-tap 864 921
            elif test $(basename $0) = cell-mail; then
                adb shell input touchscreen swipe 586 878 586 268 500
                adb-tap 560 1840 #
                adb-long-press 322 283
                adb-tap 505 192
                adb-tap 998 174
            else # weixin and qq
                adb-tap 560 1840 # ç‚¹ä¸€ä¸‹åº•éƒ¨è¾“å…¥æ¡†ï¼Œå¼¹å‡ºè½¯é”®ç›˜
                sleep .1
                adb-tap 560 1840 # å†ç‚¹ä¸€ä¸‹ï¼Œå¯èƒ½åœ¨å‡ºé”®ç›˜ï¼Œéœ€è¦è¾“å…¥ä¸€ä¸ªç©ºæ ¼
                adb-long-press 560 976 # é•¿ç‚¹è¾“å…¥æ¡†
                adb-tap 525 855 # ç‚¹ä¸€ä¸‹ç²˜è´´é’®
                adb-tap 976 976 # ç‚¹ä¸€ä¸‹å‘é€é’®
            fi
        ) 10> ~/.logs/$(basename $0).lock-send &
    done
) 9> ~/.logs/$(basename $0).lock
#+END_SRC

ç„¶åæœ‰Nä¸ªè„šæœ¬éƒ½æ˜¯æŒ‡å‘è¿™ä¸ª adb-send-weixin çš„è½¯é“¾æ¥ï¼š

#+BEGIN_EXAMPLE
$ls -l |grep weixin
-rwxr-xr-x 1 bhj bhj    1807 Jun 23 16:53 adb-send-weixin*
lrwxrwxrwx 1 bhj bhj      15 Jun 20 11:55 cell-mail -> adb-send-weixin*
lrwxrwxrwx 1 bhj bhj       6 Jun 17 11:16 google+ -> weixin*
lrwxrwxrwx 1 bhj bhj      15 Jun 10 11:27 qq -> adb-send-weixin*
lrwxrwxrwx 1 bhj bhj       6 Jun 23 16:47 t1-sms -> weixin*
lrwxrwxrwx 1 bhj bhj      15 Jun 20 1ğŸ˜‡6 weibo -> adb-send-weixin*
lrwxrwxrwx 1 bhj bhj      15 Jun  7 12:04 weixin -> adb-send-weixin*
#+END_EXAMPLE

è¿™ä¸ªè„šæœ¬å¤§è‡´çš„å·¥ä½œæ˜¯å¯åŠ¨ä¸€ä¸ªæ­»å¾ªç¯ï¼Œç¬¬äºŒæ®µé‡Œçš„ =while true; do
... done= ï¼Œå…ˆç”¨ask-for-input-with-emacsè·å–æˆ‘è¦åœ¨weixin/weiboé‡Œè¾“å…¥çš„
å†…å®¹ï¼Œç„¶åç”¨putclip-androidæŠŠè¿™ä¸ªå†…å®¹æ”¾åˆ°æ‰‹æœºçš„å‰ªè´´æ¿é‡Œå»ï¼Œç„¶åç”¨ä¸€å †
adb-long-press/adb-tapç­‰æ“ä½œæŠŠè´´åˆ°æ‰‹æœºåº”ç”¨ç¨‹åºé‡Œå¹¶å‘é€å‡ºå»ã€‚

ä¸Šé¢ç”¨çš„åæ ‡å…¨æ˜¯ç”¨æˆ‘å‚çš„Smartisan T1æ‰‹æœºé€‚é…å‡ºæ¥çš„ï¼Œå¦‚æœç”¨åˆ«çš„å‚çš„æ‰‹æœº
çš„è¯ï¼Œå¤§å®¶éœ€è¦è‡ªå·±é€‚é…ä¸€ä¸‹å•¦ã€‚

é€‚é…çš„æ–¹æ³•æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ‰“å¼€æ‰‹æœºè®¾ç½®é‡Œçš„å¼€å‘è€…é€‰é¡¹ï¼Œå‹¾é€‰ä¸Šæ˜¾ç¤ºè§¦æ‘¸æ“ä½œ
å’ŒæŒ‡é’ˆä½ç½®ï¼Œè¿™æ ·ä½ åœ¨å±å¹•ä¸ŠæŒ‡æŒ‡ç‚¹ç‚¹çš„æ—¶å€™ï¼ŒX/Yçš„åº§æ ‡ä¼šè¢«æ˜¾ç¤ºä¸Šå±å¹•ä¸Šæ–¹ã€‚
å¦ä¸€ç§åˆ™æ˜¯æˆ‘å†™çš„å¦ä¸€ä¸ªå°è„šæœ¬ï¼Œåœ¨å±å¹•ä¸Šé•¿æŒ‰æ‰‹æŒ‡åœ¨ä¸€ä¸ªä½ç½®ï¼Œä¼šæ‰“åº”å‡ºç›¸åº”
çš„åæ ‡ã€‚äºŒè€…å„æœ‰åˆ©å¼Šï¼Œä¸»è¦æ˜¯ç¬¬ä¸€ç§è€æ˜¯è¦æ‰“å¼€ä¹‹ååˆè¦è®°å¾—å…³é—­ï¼Œæ“ä½œæ¯”è¾ƒ
ç¹çï¼Œç¬¬äºŒç§å‘¢ï¼Œåˆ™ä¸æ˜¯å®æ—¶çš„æ˜¾ç¤ºåæ ‡ã€‚å“¦å¯¹äº†ï¼Œæˆ‘è‡ªå·±ç°åœ¨æ˜¯ç”¨ç¬¬äºŒç§æ¯”è¾ƒ
å¤šäº†ï¼Œå› ä¸ºæˆ‘å¯ä»¥æˆªä¸€å¼ å›¾ä¸‹æ¥æ…¢æ…¢ç‚¹ã€‚Smartisan T1æˆªå›¾çœŸçš„æ˜¯è¶…æ–¹ä¾¿ã€‚å°è„š
æœ¬çš„ä½ç½®åœ¨[[https://github.com/baohaojun/system-config/raw/master/bin/adb-get-xy][adb-get-xy]]ã€‚

#+BEGIN_SRC sh
#!/bin/bash

adb getevent -l |perl -ne '
    if (m/ABS_MT_POSITION_/) {
        chomp;
        @fields = split;
        ($name, $val) = @fields[2,3];
        $val = hex($val);
        print "$name: $val\n";
    }
'
#+END_SRC

å…¶è¾“å‡ºç»“æœå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š

#+BEGIN_EXAMPLE
$adb-get-xy
ABS_MT_POSITION_X: 550
ABS_MT_POSITION_Y: 1006
ABS_MT_POSITION_X: 549
ABS_MT_POSITION_X: 548
ABS_MT_POSITION_X: 547
ABS_MT_POSITION_X: 546
ABS_MT_POSITION_X: 545
ABS_MT_POSITION_X: 544
ABS_MT_POSITION_X: 543
#+END_EXAMPLE

ä¸‹é¢æ¥è®²ä¸€ä¸‹adb-send-to-weixiné‡Œç”¨åˆ°çš„ä¸€äº›å…¶ä»–è¾…åŠ©è„šæœ¬å’Œå‘½ä»¤ã€‚

** flock

flockæ˜¯å¸¸ç”¨çš„ä¸€ä¸ªshellä¸‹é€šè¿‡æ–‡ä»¶é”æ¥è¿›è¡Œè¿›ç¨‹é—´åŒæ­¥äº’æ–¥çš„æœºåˆ¶ï¼Œåœ¨è¿™é‡Œæˆ‘
ç”¨äº†ä¸¤ä¸ªflockï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯è¯´å¦‚æœå‘ç°weixinæ­»å¾ªç¯å·²ç»åœ¨è·‘çš„è¯ï¼Œæ–°çš„æ­»å¾ª
ç¯å°±ä¸å¼€å¯äº†ï¼Œè€Œæ˜¯é€šè¿‡find-or-execæŠŠEmacsçª—å£æåˆ°å‰é¢æ¥ï¼Œå†é€šè¿‡
emacsclientæŠŠæ­£åœ¨è¿›è¡Œweixinç¼–è¾‘çš„Emacs bufferè°ƒåˆ°å‰é¢æ¥ã€‚

å¦ä¸€ä¸ªflockåˆ™æ˜¯ä¸ºäº†è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œæ¯æ¬¡æˆ‘ç¼–è¾‘å®Œä¸€æ¡weixinå†…å®¹ä¹‹åï¼Œæˆ‘å°±
åœ¨åå°(bashçš„&ç¬¦å·)æ‰§è¡Œæ‰‹æœºä¸Šçš„æ“ä½œï¼ˆæ”¾å‰ªè´´æ¿ã€å„ç§é•¿æŒ‰çŸ­æŒ‰ï¼‰ï¼Œè¿™äº›å
å°æ“ä½œæˆ‘æ˜¯è‚¯å®šä¸å¸Œæœ›å®ƒä»¬æœ‰é‡åˆçš„ï¼Œå¦åˆ™å°±ä¼šä¹±å¥—ã€‚è¿™æ ·å‘¢ï¼Œæˆ‘å¯ä»¥é©¬ä¸Šè¿›è¡Œ
ä¸‹ä¸€æ¡å¾®ä¿¡çš„ç¼–è¾‘ï¼Œç„¶åæ˜¯å†ä¸‹ä¸€æ¡ï¼Œä¸éœ€è¦ç­‰æ‰‹æœºæŠŠä¸Šä¸€æ¡å¾®ä¿¡å‘å‡ºå»å…ˆï¼Œå¦‚
æœweixinèŠå¤©ä¹Ÿèƒ½æœ‰flowçš„çŠ¶æ€çš„è¯ï¼Œè¿™æ ·å°±èƒ½ä¿è¯æˆ‘çš„flowçŠ¶æ€ä¸ä¼šè¢«æ‰“æ–­äº†ğŸ˜Š

** find-or-exec

è¿™æ˜¯ä¸€æ®µsawfishè„šæœ¬ï¼Œå¯¹æˆ‘çš„Linuxæ¡Œé¢ç®¡ç†å™¨æ˜¯sawfishã€‚è§ [[https://github.com/baohaojun/system-config/raw/master/bin/find-or-exec][find-or-exec]] ã€‚

#+BEGIN_SRC sh
#!/bin/bash

set -e

function die() {
    echo Error: "$@"
    exit -1
}

if test $# = 0; then
    die "Error: Usage $(basename $0) window_class [program_to_exec]"
fi

if test "$1" = konsole; then
    shift;
    set -- "konsole|xfce4-terminal" "$@"
fi

sawfish_exp=$(printf '(find-window-or-exec "%s" "%s")' "$1" "${2:-true}")

sawfish-client -e "$sawfish_exp" >/dev/null 2>&1 &
#+END_SRC

è¿™æ˜¯ä¸€æ®µbashè„šæœ¬ï¼Œå¦‚æœä½ ç”¨bash -xçœ‹å®ƒçš„traceçš„è¯ï¼Œä½ ä¼šå‘ç°ï¼š

#+BEGIN_EXAMPLE
$bash -x find-or-exec emacs
+ set -e
+ test 1 = 0
+ test emacs = konsole
++ printf '(find-window-or-exec "%s" "%s")' emacs true
+ sawfish_exp='(find-window-or-exec "emacs" "true")'
+ sawfish-client -e '(find-window-or-exec "emacs" "true")'
#+END_EXAMPLE

æœ€åä¼šè°ƒä¸€ä¸ªfind-window-or-execçš„sawfishå‡½æ•°ï¼Œæˆ‘æ˜¯è¿™æ ·å®šä¹‰çš„ ï¼ˆè§æˆ‘çš„
[[https://github.com/baohaojun/system-config/raw/master/.sawfishrc][.sawfishrc]]ï¼‰ï¼š

#+BEGIN_SRC sawfish
(defun find-window-or-exec (wclass-or-lambda #!optional wcommand)
  (if (eq (catch 'wFound
            (mapc (lambda (window)
                    (when (if (stringp wclass-or-lambda)
                              (string-match wclass-or-lambda (bhj-window-class window) 0 t)
                            (when functionp wclass-or-lambda
                                  (write (stderr-file) "hello world\n")
                                  (wclass-or-lambda window)))

                      (bhj-activate-window window)
                      (throw 'wFound 'wFound)))
                  (stacking-order)))
          'wFound)
      t
    (if wcommand
        (system (concat wcommand "&")))
    nil))
#+END_SRC

è¿™ä¸ªå°±ä¸å±•å¼€äº†ï¼Œå†å±•å¼€å°±è¦æ ˆæº¢å‡ºäº†ğŸ˜Š

ä½†æ˜¯find-or-execçš„ç¡®æ˜¯ä¸€ä¸ªæˆ‘å¾ˆå¸¸ç”¨çš„æ–¹ä¾¿æˆ‘åœ¨Emacs/Terminalä¹‹é—´åˆ‡æ¢çš„ç¨‹
åºã€‚è®¾æƒ³æˆ‘åœ¨Terminalåº•ä¸‹æ‰§è¡Œä¸€æ®µbashè„šæœ¬ï¼Œé‡Œé¢ç”¨åˆ°äº†emacsï¼Œå®ƒèƒ½ç›´æ¥å¸®
æˆ‘æŠŠEmacsçª—å£å¼¹åˆ°å‰é¢æ¥ï¼›ç­‰Emacsæ“ä½œç»“æŸåï¼Œå®ƒåˆèƒ½æŠŠTerminalç»™æˆ‘å¼¹å›æ¥ã€‚

å¸¸æœ‰ä¸€äº›Emacsçš„å¤§ä»™è¯´ç”¨Emacså¯ä»¥åœ¨Emacså†…å¼€eshellä»€ä¹ˆçš„ï¼Œæ°¸è¿œä¸éœ€è¦ç¦»
å¼€Emacsçª—å£ã€‚ä½†é¦–å…ˆeshellç­‰éƒ½æ¯”è¾ƒæœ‰é—®é¢˜ï¼Œè¿˜æœ‰æ€§èƒ½ä»€ä¹ˆçš„ã€‚å¹¶ä¸”ä½ è¿˜æ˜¯å¾—
åˆ‡æ¢bufferå˜›ã€‚ç„¶åæˆ‘çš„find-or-execå¯ä»¥åšåˆ°è‡ªåŠ¨å¸®æˆ‘åˆ‡æ¢ï¼Œæ‰€ä»¥è¿™å›æˆ‘å°±æ²¡
å¬å¤§ä»™ä»¬çš„ã€‚

** putclip-android

putclip/getclipæ˜¯cygwinä¸‹çš„ç¨‹åºã€‚åœ¨Linuxåº•ä¸‹æœ‰ä¸€ä¸ªxclipï¼Œåœ¨Mac OS Xåº•
ä¸‹æœ‰ä¸€ä¸ªpbcopy/pbpasteã€‚

ä½†ä¸ºäº†æˆ‘è‡ªå·±ç¼–ç¨‹å†™è„šæœ¬ã€ç»ˆç«¯ä¸Šæ‰“å‘½ä»¤èƒ½å¤Ÿç»Ÿä¸€ï¼Œæˆ‘ä½¿ç”¨äº†design patterné‡Œ
çš„ä¸çŸ¥å“ªç§æ¨¡å¼ï¼Œåœ¨Linuxä¸‹å’ŒMac OS Xä¸‹ä¹Ÿå®ç°äº†ä¸€ä¸ªç›¸åº”åœ°ç”¨xclipå’Œ
pbcopy/pbpasteå®ç°äº†putclip/getclipã€‚

åœ¨Linuxä¸‹çš„putclipåŠŸèƒ½æœ€å¤æ‚ï¼Œä¹Ÿæœ€å¼ºå¤§ã€‚è§ [[https://github.com/baohaojun/system-config/raw/master/bin/Linux/putclip][putclip]] ã€‚

#+BEGIN_SRC sh
#!/bin/bash
if echo $SHELLOPTS | grep xtrace; then
    export SHELLOPTS
fi
if test $# != 0; then
    exec <<EOF
$@
EOF
fi

if test "$EMACS" = t -o "$REMOTEIP"; then
    rm-last-nl > /tmp/$$.putclip
    export FILE=/tmp/$$.putclip
    (
        if test "$REMOTEIP" = ""; then
            prefix=""
            arg_handler=echo
        else
            if test -e ~/.config/ssh-agent; then
                . ~/.config/ssh-agent
            fi
            ssh ${REMOTEUSER:-$USER}@$REMOTEIP remote-putclip $(whoami)@$LOCALIP:$FILE
            exit 0
        fi

        $prefix emacsclient --eval "
(let ((default-directory \"/tmp/\"))
(view-file \"$FILE\")
(kill-new (filter-buffer-substring (point-min) (point-max)))
(View-quit))"
        $prefix rm $FILE
        xclip -o -selection clipboard|xclip -i
    ) >~/.logs/putclip.log 2>&1&
else
    rm-last-nl|xclip -i -selection clipboard >/dev/null 2>&1
    xclip -o -selection clipboard|xclip -i >/dev/null 2>&1
fi
#+END_SRC

ç®€å•åœ°è¯´ï¼Œå®ƒåœ¨sshè¿œç¨‹ç™»å½•å’ŒEmacsåº•ä¸‹éƒ½èƒ½ç”¨ã€‚ä¸ºä»€ä¹ˆè¿™ä¸ªäº‹æƒ…å€¼å¾—è¯´ä¸€ä¸‹å‘¢ï¼Ÿ
å› ä¸ºé¦–å…ˆsshç™»å½•ä¹‹åå¦‚æœè¿˜èƒ½ç»§ç»­ç”¨putclipçš„è¯ï¼ˆæ²¡æœ‰ç”¨ssh -Xï¼Œæ‰€ä»¥ä¸èƒ½
xclipï¼‰ï¼Œå‘½ä»¤è¡Œå’ŒGUIèƒ½ç»“åˆå¾—æ›´å¥½ã€‚ç„¶ååœ¨Emacsä¸‹ï¼Œç›´æ¥æ“ä½œxclipæ˜¯ä¼šå¼•èµ·
æ­»é”çš„ï¼Œå› ä¸ºEmacsæ˜¯ä¸ªå•çº¿ç¨‹ç¨‹åºï¼Œå®ƒæ‰§è¡Œxclipå‘½ä»¤ä¹‹åï¼Œå°±ä¼šç­‰å¾…ç»“æŸï¼Œå¯
æ˜¯å‘¢xclipåˆè¦ç­‰æŒæœ‰ç€Xå‰ªè´´æ¿å†…å®¹çš„ç¨‹åºè·Ÿå®ƒé€šè®¯ï¼ŒæŠŠå‰ªè´´æ¿å†…å®¹ä¼ è¿‡æ¥ã€‚è®¾
æƒ³ä¸€ä¸‹æŒæœ‰Xå‰ªè´´æ¿å†…å®¹çš„ç¨‹åºå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šæ˜¯è°å‘¢ï¼Ÿå°±æ˜¯Emacsè‡ªå·±ï¼

è¿™äº›æ˜¯é¢˜å¤–è¯ï¼Œæ‚¨çœ‹æˆ‘çš„åšå®¢ä¹°ä¸€é€ä¸€ï¼Œè·Ÿputclip-androidæ²¡ä»€ä¹ˆå…³ç³»ã€‚è¿™ä¸ªè„šæœ¬è§ [[https://github.com/baohaojun/system-config/raw/master/bin/putclip-android][putclip-android]] ã€‚


#+BEGIN_SRC sh
#!/bin/bash

if test "$#" = 0; then
    set -- "$(ask-for-input-with-emacs)"
fi
echo -n "$@" > ~/.logs/$(basename $0).txt

adb "set -x;
echo -n $(printf %q "$@") > /sdcard/putclip.txt
am startservice -n com.bhj.setclip/.PutClipService
for x in \$(seq 1 20); do if test -e /sdcard/putclip.txt; then busybox sleep .1; echo \$x; else exit; fi; done"
#+END_SRC

*** adb

ç¬¬ä¸‰å±‚æ ‡é¢˜äº†ã€‚æˆ‘ä¿è¯ä¸ä¼šå‡ºç°ç¬¬å››å±‚æ ‡é¢˜ã€‚

ä¸Šé¢è¿™ä¸ªè„šæœ¬é‡Œæˆ‘çš„adbå‘½ä»¤ç”¨æ³•å¾ˆå¥‡ç‰¹ï¼Œå®ƒç›´æ¥è·Ÿäº†ä¸€å¤§æ®µshellè„šæœ¬ï¼Œæ²¡æœ‰ç”¨
adb shell COMMANDè¿™ä¸ªå½¢å¼ã€‚è¿™æ˜¯å› ä¸ºæˆ‘å«Œæ¯æ¬¡éƒ½è¦æ‰“shellè¿™ä¸ªå•è¯å¤ªç´¯äº†ã€‚

å¦‚æœä½ ä»¥ä¸ºæˆ‘åªæ˜¯æŠŠshellå»æ‰è€Œå·²çš„è¯ä½ å°±é”™äº†ï¼

æˆ‘æ›´å¤šçš„å·¥ä½œæ˜¯åœ¨å¼•å·çš„å¤„ç†å’Œç»ˆç«¯çš„äº¤äº’ä¸Šã€‚

å…ˆè¯´è¯´ç»ˆç«¯çš„äº¤äº’ã€‚åƒsuå‘½ä»¤é‚£æ ·ï¼Œsu -c "echo hello world" æœ‰ç‚¹åƒadb
shell "echo hello world"ï¼Œä½† su -c "bash"å°±è·Ÿadb shell bashå¾ˆä¸ä¸€æ ·äº†ï¼Œ
å‰è€…ä½ èƒ½å¾—åˆ°ä¸€ä¸ªå¯ä»¥äº¤äº’çš„shellï¼Œåè€…ä½ è¾“å…¥ä»»ä½•å‘½ä»¤éƒ½æ²¡æœ‰å“åº”ã€‚è¿™ä¸ªé—®
é¢˜æˆ‘æ˜¯é€šè¿‡expectè§£å†³çš„ã€‚

æˆ‘çš„adbåŒ…è£…è¿‡ä¹‹åæ‰§è¡Œadb shell bashæ—¶ï¼Œå®ƒä¼šæ‰§è¡Œexpectï¼Œç„¶åspawnå‡ºä¸€ä¸ª
adb shellï¼Œç„¶åæŠŠæ‰€æœ‰çš„å‚æ•°ï¼ˆåœ¨è¿™é‡Œæ˜¯bashï¼‰å‘è¿‡å»ï¼Œæ‰€ä»¥æœ€åçš„ç»“æœå°±åƒ
æ˜¯ä½ è‡ªå·±å¯åŠ¨äº†ä¸€ä¸ªadb shellï¼Œç„¶åå†åœ¨å¯ä»¥äº¤äº’çš„æç¤ºç¬¦ä¸‹è¾“å…¥äº†bashã€‚è§
[[https://github.com/baohaojun/system-config/raw/master/bin/adb-expect][adb-expect]]ã€‚

å¼•å·çš„å¤„ç†åˆ™ç›¸å½“çš„å¥‡è‘©ã€‚adbçš„.cç¨‹åºåœ¨å¤„ç†å‚æ•°çš„æ—¶å€™å¦‚æœå‘ç°æŸä¸ªå‚æ•°é‡Œ
å¸¦æœ‰ç©ºæ ¼ï¼Œå°±ä¼šåœ¨å®ƒçš„ä¸¤å¤´å„åŠ ä¸Šä¸€ä¸ªåŒå¼•å·ã€‚æ‰€ä»¥ï¼š

#+BEGIN_EXAMPLE
{ bhj@bhj-laptop /home/bhj/system-config/bin Ret: 130 @ 21:51:38 }
$the-true-adb shell echo "hello    world"
hello    world

{ bhj@bhj-laptop /home/bhj/system-config/bin }
$echo "hello    world"
hello    world
#+END_EXAMPLE

è¿™ä¸ªè·Ÿç›´æ¥åœ¨bashé‡Œæ‰“ =(echo "hello world")= æ•ˆæœæ˜¯ä¸€è‡´çš„ï¼ˆä¸ºäº†è®©è¿™ä¸ªå‘½
ä»¤åœ¨org-modeé‡Œå˜æˆmonospaceå­—ä½“ï¼Œæˆ‘å¿…é¡»åŠ ä¸€ä¸ªæ‹¬å·ï¼Œæœ‰è°çŸ¥é“æ›´å¥½çš„åŠæ³•
ä¹ˆï¼Ÿï¼‰ã€‚å¯æ˜¯åœ¨bashé‡Œä½ è¿˜å¯ä»¥ =(echo 'hello   "   world')= ï¼Œå¯æ˜¯åœ¨adbä¸‹å°±ä¼šå‡ºé”™ï¼š

#+BEGIN_EXAMPLE
{ bhj@bhj-laptop /home/bhj/system-config/bin Ret: 130 @ 21:54:59 }
$(echo 'hello   "   world')
hello   "   world

{ bhj@bhj-laptop /home/bhj/system-config/bin }
$the-true-adb shell echo 'hello   "   world'
/system/bin/sh: no closing quote
#+END_EXAMPLE

å¦‚æœä½ ç”¨straceå»çœ‹æ€ä¹ˆå›äº‹å„¿çš„è¯ï¼Œä½ ä¼šå‘ç°adbé€ç»™æ‰‹æœºæ‰§è¡Œçš„å‘½ä»¤æ˜¯è¿™æ ·çš„ï¼š

#+BEGIN_EXAMPLE
{ bhj@bhj-laptop /home/bhj/system-config/bin Ret: 130 @ 21:55:55 }
$strace -e write -f the-true-adb shell echo 'hello   "   world'
[ Process PID=7340 runs in 32 bit mode. ]
write(3, "000c", 4)                     = 4
write(3, "host:version", 12)            = 12
write(3, "0012", 4)                     = 4
write(3, "host:transport-any", 18)      = 18
write(3, "001e", 4)                     = 4
write(3, "shell:echo \"hello   \"   world\"", 30) = 30
write(1, "/system/bin/sh: no closing quote"..., 34/system/bin/sh: no closing quote
) = 34
#+END_EXAMPLE

æŠŠå¼•å·å½’æ•´ä¸€ä¸‹ï¼Œæ‰‹æœºçš„shçœ‹åˆ°çš„å‘½ä»¤æ˜¯ =(echo "hello " world")= ï¼ˆå»æ‰æ‹¬
å·ï¼‰ã€‚

æŸ¥çœ‹ä¸€ä¸‹adbå¯¹å¼•å·çš„å¤„ç†ï¼š

#+BEGIN_SRC c
            quote = (**argv == 0 || strchr(*argv, ' '));
            if (quote)
                strcat(buf, "\"");
            strcat(buf, *argv++);
            if (quote)
                strcat(buf, "\"");
#+END_SRC

èƒ½ä¸èƒ½æŠŠå¼•å·å¼„å¯¹æ˜¯bashè„šæœ¬ç¼–ç¨‹åŠŸåº•çš„ä¸€ç§ä½“ç°ğŸ˜Š å¦‚ä¹‹å‰æ‰€è¿°ï¼Œå¦‚æœæˆ‘æ˜¯åœ¨
ç”¨adb-expectæ‰“å¼€ä¸€ä¸ªç»ˆç«¯ç»™æ¯ä¸ªéäº¤äº’å¼çš„ =adb shell echo hello= è°ƒç”¨çš„
è¯ï¼Œé‚£å¼•å·ä¸æ˜¯ä¸€ä¸ªé—®é¢˜ï¼š

#+BEGIN_EXAMPLE
{ bhj@bhj-laptop /home/bhj/src/android/system/core/adb }
$adb-expect echo 'hello   "   world'
spawn the-true-adb shell
root@msm8974sfo:/ # exec 'echo' 'hello   "   world'
hello   "   world
#+END_EXAMPLE

å¯æ˜¯è¿™æ ·å¤ªå½±å“æ€§èƒ½äº†ï¼Œå¹¶ä¸”ä¼šå½±å“æˆ‘å¯¹adbè¿›è¡Œç¼–ç¨‹ï¼Œæˆ‘å¿…é¡»æŠŠå‰é¢çš„ä¸¤è¡Œè¾“
å‡ºç»™è¿‡æ»¤æ‰ã€‚

æ‰€ä»¥æˆ‘è¿˜æ˜¯æŠŠå¼•å·æœºåˆ¶ç¡¬ç”Ÿç”Ÿç»™å®ƒæ°æ­£äº†ï¼š

#+BEGIN_SRC sh
            IFS=$'\n'
            for x in "$@"; do
                args=("${args[@]}" $(
                             if test "$(printf %q "$x")" != "$x"; then
                                 # echo \"\'"$(echo -n "$x" | perl -npe "s!'!\\'!")"\'\"
                                 printf \"%q\" "$x"
                             else
                                 printf %q "$x"
                             fi))
            done

            exec the-true-adb ${args[@]}
#+END_SRC

å¦‚æœå‘ç°æŸä¸ªå‚æ•° (the x in "$@") éœ€è¦ quote çš„è¯( ~(test "$(printf %q
"$x")" != "$x")~ )ï¼Œé‚£æˆ‘ä»¬å°±ç»™å®ƒquoteï¼Œå¹¶å‰åå„åŠ ä¸€ä¸ªåŒå¼•å·ï¼š
ï¼ˆ ~(printf \"%q\" "$x")~ ï¼‰ã€‚å¦åˆ™å°±åªquoteä½†ä¸åŠ åŒå¼•å·ã€‚å› ä¸ºåœ¨åº•ä¸‹
=exec the-true-adb ${args[@]}= çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ²¡æœ‰ç»™ =${args[@]}= åŠ ä¸ŠåŒ
å¼•å·ï¼Œæ‰€ä»¥ä¹‹å‰çš„quoteè¢«å–æ¶ˆï¼ˆprintf %qï¼‰ï¼Œä¼ è¿‡å»çš„å‚æ•°è·Ÿä¹‹å‰æ˜¯ä¸€æ ·çš„ï¼Œ
ä½†ä¸åŒçš„æ˜¯æœ‰ä¸€äº›å‚æ•°å‰åå„åŠ äº†ä¸€ä¸ªåŒå¼•å·ï¼Œè¿™äº›å‚æ•°è¢«adbçš„.cç¨‹åºå†åœ¨å‰
åå„åŠ ä¸€åŒå¼•å·ï¼Œæœ€åç»“æœç­‰äºæ²¡åŠ ï¼Œå¾—åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„bashå¼•å·è¡Œä¸ºï¼

æˆ‘çš„adbè„šæœ¬åœ¨ [[https://github.com/baohaojun/system-config/raw/master/bin/overide/adb][adb]] ï¼Œæˆ‘è‡ªå·±å·²ç»å¿«çœ‹ä¸æ˜ç™½äº†ã€‚

*** PutClipService

åˆä¸€ä¸ªç¬¬ä¸‰çº§æ ‡é¢˜ï¼Œputclip-androidç”¨åˆ°çš„ä¸€ä¸ªæ‰‹æœºå°apkã€‚è¿™ä¸ªç¨‹åºè§ [[https://github.com/baohaojun/system-config/raw/master/gcode/SetClip/src/com/bhj/setclip/PutClipService.java][PutClipService.java]] ã€‚

#+BEGIN_SRC java
package com.bhj.setclip;

import android.app.Service;
import android.content.ClipboardManager;
import android.content.ClipData;
import android.content.Intent;
import android.os.IBinder;
import android.widget.Toast;
import java.io.File;
import java.io.FileReader;

public class PutClipService extends Service {
    @Override
    public IBinder onBind(Intent intent) {
        return null;
    }

    @Override
    public int onStartCommand(Intent intent,  int flags,  int startId)  {
        try {
            FileReader f = new FileReader(new File("/sdcard/putclip.txt"));
            char[] buffer = new char[1024];
            int n = f.read(buffer);
            String str = new String(buffer, 0, n);
            ClipboardManager mClipboard;
            mClipboard = (ClipboardManager)getSystemService(CLIPBOARD_SERVICE);
            mClipboard.setPrimaryClip(ClipData.newPlainText("Styled Text", str));
            File putclip = new File("/sdcard/putclip.txt");
            putclip.delete();
        } catch (Exception e) {
            Toast.makeText(this, "Something went wrong in putclip: " + e.getMessage(), Toast.LENGTH_SHORT).show();
        }
        return START_STICKY;
    }

    @Override
    public void onDestroy() {
    }
}
#+END_SRC

æœ€åputclip-androidé‡Œæ˜¯é€šè¿‡am startserviceæ¥å¯åŠ¨è¿™ä¸ªserviceçš„ã€‚è¿™ä¸ª
javaç¨‹åºä¼šæ‰“å¼€adb pushä¸Šæ¥çš„weixinå†…å®¹æ–‡ä»¶(/sdcard/putclip.txtï¼‰ï¼Œè¯»å‡º
æ¥ï¼Œæ”¾è¿›å‰ªè´´æ¿ï¼Œåˆ æ‰è¿™ä¸ªæ–‡ä»¶ã€‚è„šæœ¬é‡Œæœ‰ä¸€ä¸ªæ­»å¾ªç¯ä¸€ç›´åœ¨ç­‰å¾…è¿™ä¸ªæ–‡ä»¶è¢«åˆ 
é™¤æ‰è¿”å›ã€‚

* adb-long-press å’Œ adb-tap

è¿™ä¸¤ä¸ªåŸºæœ¬ä¸Šå°±æ˜¯adbè‡ªå¸¦çš„inputå‘½ä»¤çš„å°è£…ã€‚å…¶ä¸­long-pressåœ¨adb inputå‘½
ä»¤é‡Œæ˜¯æ²¡æœ‰çš„ï¼Œä½†æ˜¯ç½‘ä¸ŠæŸ¥ä¸€ä¸‹ä¹Ÿèƒ½æŸ¥åˆ°ç”¨swipeæ¥å¯ä»¥æ¨¡æ‹Ÿå‡ºæ¥ï¼ˆè§
[[https://github.com/baohaojun/system-config/raw/master/bin/adb-long-press][adb-long-press]]ï¼‰ï¼š

#+BEGIN_SRC sh
#!/bin/bash

seconds=550
if test $# = 5 -o $# = 3; then
    seconds=$1
    shift
fi
if test $# = 4; then
    adb shell input touchscreen swipe $1 $2 $3 $4 $seconds
elif test $# = 2; then
    adb shell input touchscreen swipe $1 $2 $1 $2 $seconds
fi
#+END_SRC

* sawfishå¿«æ·é”®

#+BEGIN_SRC sawfish
(bind-keys s-h-keymap "w"  '(system "weixin&"))
(bind-keys global-keymap "XF86Mail" '(synthesize-multiple-events "C-x" "C-s" "C-x" "#"))
#+END_SRC

è¿™æ ·ï¼Œæˆ‘æŒ‰ä¸€ä¸‹ =s-h w= å°±èƒ½è°ƒå‡ºweixinçš„Emacsç¼–è¾‘ï¼Œè¾“å…¥å®Œå†…å®¹ä¹‹åï¼ŒæŒ‰ä¸€
ä¸‹æˆ‘çš„å¾®è½¯äººä½“å·¥å­¦4000é”®ç›˜ä¸Šçš„Mailé”®ï¼Œå°±ä¼šåƒæŒ‰é”®å°ç²¾çµä¸€æ ·ç»™Emacså‘4ä¸ª
é”®ï¼Œ =C-x C-s C-x #= ï¼Œæˆ‘çš„å¾®ä¿¡å°±å‘å‡ºå»äº†ã€‚

å½“ç„¶ï¼Œè¿™ä¹‹å‰ä½ éœ€è¦åšæ˜¯çš„ç¡®ä¿å·²ç»è°ƒå‡ºæ¥å¾®ä¿¡èŠå¤©çª—å£ã€‚

+å¦å¤–ï¼Œè¿™äº›è„šæœ¬éƒ½åªèƒ½åœ¨adb rootè¿‡åä½¿ç”¨å§å¥½åƒï¼Ÿä¸»è¦æ˜¯adb inputå‘½ä»¤å¿…é¡»æœ‰rootæƒé™ï¼Ÿè¿™ä¸ªä¸ç¡®å®šï¼Œä½†å³ä½¿æˆ‘ç”¨çš„æ˜¯userç‰ˆæœ¬çš„æ‰‹æœºï¼Œä¸èƒ½adb rootï¼Œæˆ‘çš„adbåŒ…è£…ä¹Ÿæœ‰ä¸€ä¸ªadb root-modeå‘½ä»¤ï¼Œè¿›å…¥ä¹‹åæ¯ä¸ªadb shell COMMANDéƒ½ä¼šè¢«é‡æ–°è§£é‡Šæˆ adb shell su -c 'quoted COMMAND'ï¼Œç›¸å½“åœ°ç»•å‘¢ï¼Œæˆ‘è‡ªå·±éƒ½å¿«è¢«ç»•æ™•äº†ã€‚+

æˆ‘è®°é”™äº†ï¼Œè¿™äº›è„šæœ¬æ˜¯ä¸éœ€è¦rootæƒé™çš„ã€‚Anyway, adb root-modeğŸ˜Š

æˆ‘çš„å¾®åšè´¦å·æ˜¯ baohaojunï¼Œæ¬¢è¿ç²‰æˆ‘ã€‚å¾®ä¿¡å·æ˜¯beagrepï¼Œæ¬¢è¿åŠ æˆ‘ã€‚æˆ‘èŠå¤©
æ‰“å­—é€Ÿåº¦å¾ˆå¿«çš„ã€‚
